### 操作XML案例

```sql

DECLARE @tenantId INT = 107353 ,
    @assessmentModuleLibId UNIQUEIDENTIFIER= 'ae3453f1-557e-4740-9c68-49fc8050b04b' ,
    @actitityManagerId UNIQUEIDENTIFIER= 'a07ad4dd-30e5-4f21-9c96-d5bd50287e82' ,
    @type INT= 1 ,-- 0 from no condition to condition, 1 is modified condition
    @StrConditions NVARCHAR(MAX) ,
    @IsSetLeadInMBOCondition NVARCHAR(50),
	@IsAutoReadMBOTarget NVARCHAR(50);

SELECT  @StrConditions = CONVERT(NVARCHAR(MAX), amla.PropertyXml.query('/AssessmentModuleSetting/ModuleSettings/ModuleSetting/StrConditions/text()')) ,
        @IsSetLeadInMBOCondition = CONVERT(NVARCHAR(50), amla.PropertyXml.query('/AssessmentModuleSetting/ModuleSettings/ModuleSetting/IsSetLeadInMBOCondition/text()')),
		@IsAutoReadMBOTarget= CONVERT(NVARCHAR(50), amla.PropertyXml.query('/AssessmentModuleSetting/ModuleSettings/ModuleSetting/IsAutoReadMBOTarget/text()'))
FROM    dbo.AssessmentModuleLibAttribute AS amla
WHERE   amla.AssessmentModuleLibId = @assessmentModuleLibId
        AND amla.TenantId = @tenantId;

IF EXISTS ( SELECT  *
            FROM    tempdb.dbo.sysobjects
            WHERE   id = OBJECT_ID(N'tempdb..#assessmentModuleTemp')
                    AND type = 'U' )
    BEGIN
        DROP TABLE #assessmentModuleTemp;
    END;
SELECT  *
INTO    #assessmentModuleTemp
FROM    dbo.AssessmentModule AS am
WHERE   am.TenantId = @tenantId
        AND am.AssessmentModuleLibId = @assessmentModuleLibId
        AND am.ActivityId IN (
        SELECT  a.AssessmentActivityId
        FROM    dbo.Assessment AS a
        WHERE   a.ActivityManagerId = @actitityManagerId );

IF @type = 0
    BEGIN
        UPDATE  ama
        SET     PropertyXml.modify('insert  <StrConditions>{sql:variable(''@StrConditions'')}</StrConditions> as last into  (/AssessmentModuleSetting/ModuleSettings/ModuleSetting)[1]')
        FROM    dbo.AssessmentModuleAttribute AS ama
        WHERE   ama.TenantId = @tenantId
                AND ama.AssessmentModuleId IN (
                SELECT  amt.Id
                FROM    #assessmentModuleTemp AS amt )
                AND ama.ActivityId IN (
                SELECT  a.AssessmentActivityId
                FROM    dbo.Assessment AS a
                WHERE   a.ActivityManagerId = @actitityManagerId );
    END;
ELSE
    BEGIN
        UPDATE  ama
        SET     PropertyXml.modify('replace value of (/AssessmentModuleSetting/ModuleSettings/ModuleSetting/StrConditions/text())[1] with sql:variable("@StrConditions")')
        FROM    dbo.AssessmentModuleAttribute AS ama
        WHERE   ama.TenantId = @tenantId
                AND ama.AssessmentModuleId IN (
                SELECT  amt.Id
                FROM    #assessmentModuleTemp AS amt )
                AND ama.ActivityId IN (
                SELECT  a.AssessmentActivityId
                FROM    dbo.Assessment AS a
                WHERE   a.ActivityManagerId = @actitityManagerId );
    END;

UPDATE  ama
SET     PropertyXml.modify('replace value of (/AssessmentModuleSetting/ModuleSettings/ModuleSetting/IsSetLeadInMBOCondition/text())[1] with sql:variable("@IsSetLeadInMBOCondition")')
FROM    dbo.AssessmentModuleAttribute AS ama
WHERE   ama.TenantId = @tenantId
        AND ama.AssessmentModuleId IN ( SELECT  amt.Id
                                        FROM    #assessmentModuleTemp AS amt )
        AND ama.ActivityId IN (
        SELECT  a.AssessmentActivityId
        FROM    dbo.Assessment AS a
        WHERE   a.ActivityManagerId = @actitityManagerId );

UPDATE  ama
SET     PropertyXml.modify('replace value of (/AssessmentModuleSetting/ModuleSettings/ModuleSetting/IsAutoReadMBOTarget/text())[1] with sql:variable("@IsAutoReadMBOTarget")')
FROM    dbo.AssessmentModuleAttribute AS ama
WHERE   ama.TenantId = @tenantId
        AND ama.AssessmentModuleId IN ( SELECT  amt.Id
                                        FROM    #assessmentModuleTemp AS amt )
        AND ama.ActivityId IN (
        SELECT  a.AssessmentActivityId
        FROM    dbo.Assessment AS a
        WHERE   a.ActivityManagerId = @actitityManagerId );



```
